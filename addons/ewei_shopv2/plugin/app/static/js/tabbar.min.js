define(['jquery.ui'], function (ui) {
    var modal = {};
    modal.init = function (params) {
        modal.attachurl = params.attachurl;
        modal.tabbar = params.tabbar;
        if (!modal.tabbar) {
            modal.tabbar = {
                color: '#999999',
                selectedColor: '#ff5555',
                borderStyle: '',
                backgroundColor: '#f7f7fa',
                list: [{
                    pagePath: "pages/index/index",
                    iconPath: "static/images/tabbar/icon-1.png",
                    selectedIconPath: "static/images/tabbar/icon-1-active.png",
                    text: "首页"
                }, {
                    pagePath: "pages/shop/caregory/index",
                    iconPath: "static/images/tabbar/icon-2.png",
                    selectedIconPath: "static/images/tabbar/icon-2-active.png",
                    text: "全部分类"
                }, {
                    pagePath: "pages/member/cart/index",
                    iconPath: "static/images/tabbar/icon-4.png",
                    selectedIconPath: "static/images/tabbar/icon-4-active.png",
                    text: "购物车"
                }, {
                    pagePath: "pages/member/index/index",
                    iconPath: "static/images/tabbar/icon-5.png",
                    selectedIconPath: "static/images/tabbar/icon-5-active.png",
                    text: "会员中心"
                }]
            }
        }
        modal.initTpl();
        modal.initItems();
        modal.initEditor();
        modal.initWindow();
        modal.initClick()
    };
    modal.initTpl = function () {
        tpl.helper("imgsrc", function (src) {
            if (typeof src != 'string') {
                return ''
            }
            if (src.indexOf('http://') == 0 || src.indexOf('https://') == 0 || src.indexOf('../addons') == 0) {
                return src
            } else if (src.indexOf('images/') == 0) {
                return modal.attachurl + src
            }
        });
        tpl.helper("count", function (data) {
            return modal.length(data)
        });
        tpl.helper("icon", function (item, index) {
            if (!item) {
                return
            }
            var path = '../addons/ewei_shopv2/plugin/app/static/images/default/tabbar/';
            if (index == 0) {
                return path + modal.getIconPath(item.selectedIconPath)
            }
            return path + modal.getIconPath(item.iconPath)
        })
    };
    modal.initItems = function () {
        var html = tpl("tpl_show_tabbar", modal.tabbar);
        $("#phone").html(html).show()
    };
    modal.initEditor = function () {
        var html = tpl("tpl_edit_tabbar", modal.tabbar);
        $("#diy-editor .inner").html(html);
        $("#diy-editor #addItem").unbind('click').click(function () {
            var max = $(this).closest('.form-items').data('max');
            var num = modal.length(modal.tabbar.list);
            if (num >= max) {
                tip.msgbox.err("最大添加 " + max + " 个！");
                return
            }
            modal.tabbar.list.push({
                pagePath: "pages/index/index",
                iconPath: "static/images/tabbar/icon-1.png",
                selectedIconPath: "static/images/tabbar/icon-1-active.png",
                text: "导航名称"
            });
            modal.initItems();
            modal.initEditor()
        });
        $("#diy-editor .del-item").unbind('click').click(function () {
            var min = $(this).closest('.form-items').data('min');
            var index = $(this).closest('.item').data('index');
            if (min) {
                var length = modal.length(modal.tabbar.list);
                if (length <= min) {
                    tip.msgbox.err("至少保留 " + min + " 个！");
                    return
                }
            }
            tip.confirm("确定删除吗", function () {
                modal.tabbar.list.splice(index, 1);
                modal.initItems();
                modal.initEditor()
            })
        });
        $("#diy-editor").find(".diy-bind").bind('input propertychange change', function () {
            var _this = $(this);
            var bind = _this.data("bind");
            var bindchild = _this.data('bind-child');
            var bindparent = _this.data('bind-parent');
            var initEditor = _this.data('bind-init');
            var value = '';
            var tag = this.tagName;
            if (tag == 'INPUT') {
                var placeholder = _this.data('placeholder');
                value = _this.val();
                value = value == '' ? placeholder : value
            } else if (tag == 'SELECT') {
                value = _this.find('option:selected').val()
            } else if (tag == 'TEXTAREA') {
                value = _this.val()
            }
            value = $.trim(value);
            if (bindchild || bindchild == 0) {
                if (bindparent || bindparent == 0) {
                    modal.tabbar[bindchild][bindparent][bind] = value
                } else {
                    modal.tabbar[bindchild][bind] = value
                }
            } else {
                modal.tabbar[bind] = value
            }
            modal.initItems();
            if (initEditor) {
                modal.initEditor()
            }
        });
        $("#diy-editor").find('[data-toggle="resetColor"]').bind('click', function () {
            var color = $(this).data('color') || '#000000';
            $(this).prev().val(color).trigger('propertychange')
        });
        $("#diy-editor").find('[data-toggle="setNull"]').bind('click', function () {
            var element = $(this).data('element');
            $(element).val('').trigger('propertychange')
        });
        $("#diy-editor").find('[data-toggle="selectIcon2"]').bind('click', function () {
            var _element = $(this).data('element');
            var _input = $(this).data('input');
            if (!_input && !_element) {
                return
            }
            var url = biz.url('app/page/selecticon2');
            $.ajax(url, {type: "get", dataType: "html", cache: false}).done(function (html) {
                var modal2 = $('<div class="modal fade" id="selectIcon2"></div>');
                $(document.body).append(modal2), modal2.modal('show');
                modal2.append2(html, function () {
                    $(document).off("click", '#selectIcon2 .item').on("click", '#selectIcon2 .item', function () {
                        var _index = $(this).data('index');
                        var path = 'static/images/tabbar/icon-' + _index + '.png';
                        var selectPath = 'static/images/tabbar/icon-' + _index + '-active.png';
                        if (_input) {
                            $(_input).find('input').eq(0).val(path).trigger('change');
                            $(_input).find('input').eq(1).val(selectPath).trigger('change')
                        }
                        if (_element) {
                            var staticpath = '../addons/ewei_shopv2/plugin/app/static/images/default/tabbar/';
                            $(_element).find('img').eq(0).attr('src', staticpath + modal.getIconPath(path));
                            $(_element).find('img').eq(1).attr('src', staticpath + modal.getIconPath(selectPath))
                        }
                        modal2.find(".close").click()
                    })
                })
            })
        });
        modal.initSortable();
        $("#diy-editor").show()
    };
    modal.initSortable = function () {
        $("#diy-editor .inner").sortable({
            opacity: 0.8,
            placeholder: "highlight",
            items: '.item',
            revert: 100,
            scroll: false,
            cancel: '.goods-selector,input,.btn',
            start: function (event, ui) {
                var height = ui.item.height();
                $(".highlight").css({"height": height + 22 + "px"});
                $(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');
                $(".highlight div").css({"line-height": height + 16 + "px"})
            },
            update: function (event, ui) {
                modal.sortItems();
                modal.initEditor();
            }
        })
    };
    modal.sortItems = function () {
        var newItems = [];
        $("#diy-editor .inner .item").each(function () {
            var index = $(this).data('index');
            console.log(index)
            newItems.push(modal.tabbar.list[index])
        });
        modal.tabbar.list = newItems;
        modal.initItems()
    };
    modal.initWindow = function () {
        $(window).bind('scroll resize', function () {
            var scrolltop = $(window).scrollTop();
            if (scrolltop > 300) {
                $("#gotop").show()
            } else {
                $("#gotop").hide()
            }
            $("#gotop").unbind('click').click(function () {
                $('body').animate({scrollTop: "0px"}, 1000)
            })
        })
    };
    modal.initClick = function () {
        $('.btn-save').click(function () {
            if ($(this).attr('stop')) {
                tip.msgbox.err("正在保存，请稍候...");
                return
            }
            $(".btn-save").attr('stop', 1).text("保存中...");
            $.post(biz.url('app/tabbar/submit'), {tabbar: modal.tabbar}, function (ret) {
                if (ret.status != 1) {
                    tip.msgbox.err(ret.result.message);
                    return
                }
                $(".btn-save[data-type='save']").text("保存导航").removeAttr('stop');
                tip.msgbox.suc('保存成功！');
                setTimeout(function () {
                    tip.confirm('底部导航要重新审核后才可生效，是否去提交？', function () {
                        location.href = biz.url('app/release')
                    })
                }, 500)
            }, 'json')
        })
    };
    modal.length = function (json) {
        if (typeof(json) === 'undefined') {
            return 0
        }
        var jsonlen = 0;
        for (var item in json) {
            jsonlen++
        }
        return jsonlen
    };
    modal.getIconPath = function (str) {
        if (!str) {
            return
        }
        return str.replace('static/images/tabbar/', '')
    };
    return modal
});