define(['core','tpl','biz/goods/picker','biz/goods/wholesalePicker'],function(h,i,j,k){var l={keywords:'',isrecommand:'',ishot:'',isnew:'',isdiscount:'',issendfree:'',istime:'',cate:'',order:'',by:'desc',merchid:0};var m={page:1,params:{},lastcateid:false,oldkeywords:false};m.init=function(c){m.params=$.extend(l,c||{});if(m.lastcateid){m.params.cate=m.lastcateid}if(m.oldkeywords){m.params.keywords=m.oldkeywords}var d=$.trim($('.container').html());if(d==''){m.page=1;m.getList()}$('form').submit(function(){$('.container').empty();m.params=l;m.page=1;m.params.keywords=$('#search').val();m.oldkeywords=m.params.keywords;window.scrollTo(100,100);m.getList();return false});$('#search').bind('input propertychange',function(){if($.trim($(this).val())==''){$('.container').empty();$('.sort .item-price').removeClass('desc').removeClass('asc');m.params=l;m.page=1;m.params.keywords='';m.getList()}});$('.sort .item').click(function(){var a=m.params.keywords;var b=$(this).data('order')||'';if(b==''){if(m.params.order!=b){m.params=l,m.params.order=''}}else if(b=='minprice'){$(this).removeClass('asc').removeClass('desc');if(m.params.order==b){if(m.params.by=='desc'){m.params.by='asc';$(this).addClass('asc')}else{m.params.by='desc';$(this).addClass('desc')}}else{m.params.by='asc';$(this).addClass('asc')}m.params.order=b}else if(b=='sales'){if(m.params.order!=b){m.params=l,m.params.order='sales',m.params.by='desc'}}$('.sort .item.on').removeClass('on'),$(this).addClass('on');if(b!='minprice'){$('.sort .item-price').removeClass('desc').removeClass('asc')}if(b=='filter'){m.showFilter();return}m.params.keywords=a;m.page=1;$('.container').html(''),$('.infinite-loading').show(),$(".content-empty").hide();m.getList()});$('#listblock').click(function(){if($(this).hasClass('icon-app')){$(this).removeClass('icon-app').addClass('icon-sort')}else{$(this).removeClass('icon-sort').addClass('icon-app')}$('.container').toggleClass('block')});$('.fui-content').infinite({onLoading:function(){if(m.page>1){$('.sort .item').each(function(){var a=$(this).data('order');if($(this).hasClass('on')&&typeof a=="undefined"){m.getList()}if($(this).hasClass('on')&&typeof a!="undefined"){var b=m.params.keywords;var a=$(this).data('order')||'';if(a==''){if(m.params.order!=a){m.params=l,m.params.order=''}}else if(a=='minprice'){if($(this).hasClass('asc')){m.params.by='asc'}else{m.params.by='desc'}m.params.order=a}else if(a=='sales'){if(m.params.order!=a){m.params=l,m.params.order='sales',m.params.by='desc'}}$('.sort .item.on').removeClass('on'),$(this).addClass('on');if(a!='minprice'){$('.sort .item-price').removeClass('desc').removeClass('asc')}if(a=='filter'){m.showFilter(true);return}m.params.keywords=b;m.params.page=m.page;m.getList()}})}}});m.bindEvents()};m.showFilter=function(b){if(!b){$('.fui-mask-m').show().addClass('visible');$('.screen').addClass('in')}else{m.getList()}$('.screen .btn').unbind('click').click(function(){var a=$(this).data('type');if($(this).hasClass('btn-danger-o')){$(this).removeClass('btn-danger-o').addClass('btn-default-o');$(this).find('.icon').hide()}else{$(this).removeClass('btn-default-o').addClass('btn-danger-o');$(this).find('.icon').show()}});$('.screen .cancel').unbind('click').click(function(){m.cancelFilter()});$('.screen .confirm').unbind('click').click(function(){$('.screen .btn').each(function(){var a=$(this).data('type');if($(this).hasClass('btn-danger-o')){m.params[a]="1"}else{m.params[a]=""}});if(m.lastcateid){m.params.cate=m.lastcateid}m.closeFilter();$('.container').html(''),$('.infinite-loading').show(),$(".content-empty").hide();m.page=1,m.getList()});m.bindCategoryEvents();$('.fui-mask-m').unbind('click').click(function(){m.closeFilter()})};m.cancelFilter=function(){m.closeFilter();$('.screen .btn').each(function(){if($(this).hasClass('btn-danger-o')){$(this).removeClass('btn-danger-o').addClass('btn-default-o');$(this).find('.icon').hide();m.params[$(this).data('type')]=""}});$('.screen .cate .item nav').removeClass('on');$('.screen .cate .item:first-child ~ .item').html('');l.cate='';m.params=l,m.getList()};m.bindCategoryEvents=function(){$('.screen .cate .item nav').unbind('click').click(function(){var a=$(this).closest('.cate').data('catlevel');var b=$(this).parent();b.find('nav.on').removeClass('on');$(this).addClass('on');var c=b.data('level');m.lastcateid=$(this).data('id');if(c>=a){return}var d=$(".screen .cate .item[data-level='"+c+"'] ~ .item");d.html('');var e=$(this).closest('.item').next('.item');var f=window.category['children'][m.lastcateid];var g="";$.each(f,function(){g+="<nav data-id='"+this.id+"'>"+this.name+"</nav> "});e.html(g);m.bindCategoryEvents()})};m.closeFilter=function(){$('.fui-mask-m').removeClass('visible').transitionEnd(function(){$('.fui-mask-m').hide()});$('.screen').removeClass('in')};m.bindEvents=function(){$('.buy').unbind('click').click(function(){var a=$(this).closest('.fui-goods-item').data('goodsid');var b=$(this).closest('.fui-goods-item').data('type');if(b==20){location.href=h.getUrl('goods/detail',{id:a})}else if(b==9){location.href=h.getUrl('cycelbuy/goods/detail',{id:a})}else{if($(this).data('type')==4){k.open({goodsid:a})}else{j.open({goodsid:a,total:1,optionid:0})}}})};m.getList=function(){m.params.page=m.page;h.json('goods/get_list',m.params,function(a){$('.infinite-loading').hide();var b=a.result;if(b.total<=0){$('.content-empty').show();$('.fui-content').infinite('stop')}else{$('.content-empty').hide();$('.fui-content').infinite('init');if(b.list.length<=0||b.list.length<b.pagesize){m.stopLoading=true;$('.fui-content').infinite('stop')}}m.page++;h.tpl('.container','tpl_goods_list',b,m.page>1);m.bindEvents()})};return m});